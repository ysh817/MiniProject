<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="UserInfoDao">
	<resultMap type="UserInfo" id="UserInfoMap">
		<result property="userId" column="USER_ID"/>
		<result property="userName" column="USER_NAME"/>
		<result property="userPassword" column="USER_PASSWORD"/>
		<result property="agentCode" column="AGENT_CODE"/>
		<result property="agentName" column="AGENT_NAME"/>
		<result property="useStartDate" column="USE_START_DATE"/>
		<result property="useEndDate" column="USE_END_DATE"/>
		<result property="status" column="STATUS"/>
		<result property="tableauIndex" column="TABLEAU_INDEX"/>
		<result property="tableauAccessId" column="TABLEAU_ACCESS_ID"/>
		<result property="userEmail" column="USER_EMAIL"/>
		<result property="gradeCode" column="GRADE_CODE"/>
		<result property="gradeName" column="GRADE_NAME"/>
		<result property="accessIp" column="ACCESS_IP"/>
	</resultMap>
	
	<select id="getDbSelectOne" parameterType="Map" resultMap="UserInfoMap">
		SELECT
			TU.USER_ID
			,TU.USER_NAME
			,TU.USER_PASSWORD
			,TU.AGENT_CODE
			,TA.AGENT_NAME
			,DATE_FORMAT(TA.USE_START_DATE, '%Y-%m-%d') AS USE_START_DATE
			,DATE_FORMAT(TA.USE_END_DATE, '%Y-%m-%d') AS USE_END_DATE
			,TU.STATUS
			,TU.TABLEAU_INDEX
			,USER_EMAIL
			,TU.ACCESS_IP
		FROM TBL_USER_INFO TU LEFT JOIN TBL_AGENT_INFO TA
		ON TU.AGENT_CODE = TA.AGENT_CODE
		WHERE TU.USER_ID = #{loginId} 
		AND TU.USER_PASSWORD = #{loginPw}
	</select>	
	
	<select id="getDbUserInfo" parameterType="String" resultMap="UserInfoMap">
		SELECT
			TU.USER_ID
			,TU.USER_NAME
			,TU.USER_PASSWORD
			,TU.AGENT_CODE
			,TA.AGENT_NAME
			,DATE_FORMAT(TU.USE_START_DATE, '%Y-%m-%d') AS USE_START_DATE
			,DATE_FORMAT(TU.USE_END_DATE, '%Y-%m-%d') AS USE_END_DATE
			,TU.STATUS
			,TU.TABLEAU_INDEX
			,TU.USER_EMAIL
			,TU.GRADE_CODE
			,TU.ACCESS_IP
		FROM TBL_USER_INFO TU LEFT JOIN TBL_AGENT_INFO TA
		ON TU.AGENT_CODE = TA.AGENT_CODE
		WHERE USER_ID=#{userId}
	</select>
	
	<select id="getDbAuthKey" parameterType="String" resultType="String">
		SELECT
			AUTH_KEY
		FROM TBL_AUTHKEY_MAP
		WHERE USER_ID = #{userId}
	</select>
	
	<insert id="setDbAuthKeyMap" parameterType="Map">
		INSERT INTO TBL_AUTHKEY_MAP(
			USER_ID
			,AUTH_KEY
			,STATUS
			,ADD_ID
			,ADD_IP
			,ADD_DATE
			
		) VALUES (
			#{userId}
			,#{authKey}
			,#{status}
			,#{userId}
			,#{loginIp}
			,now()
		) ON DUPLICATE KEY UPDATE 
			AUTH_KEY = #{authKey}
			, STATUS = #{status}
			, MOD_ID = #{userId}
			, MOD_IP = #{loginIp}
			, MOD_DATE = now()
			
	</insert>
	
	<select id="mirsUserList" resultMap="UserInfoMap">
		SELECT
			A.USER_ID
			, A.USER_NAME
			, A.TABLEAU_INDEX
			, B.USER_ID AS TABLEAU_ACCESS_ID
			, C.GRADE_NAME
			, IFNULL(A.USER_EMAIL,'')AS USER_EMAIL
			, IFNULL(A.USE_START_DATE,'')AS USE_START_DATE
			, IFNULL(A.USE_END_DATE,'')AS USE_END_DATE
			, A.ACCESS_IP
		FROM TBL_USER_INFO A
			LEFT OUTER JOIN TBL_TABLEAU_USER_INFO B
			ON A.TABLEAU_INDEX = B.SEQ_NO
			LEFT OUTER JOIN TBL_USER_GRADE C
			ON A.GRADE_CODE = C.GRADE_CODE
	</select>
	
	
	<insert id="insertUser" parameterType="UserInfo">
		INSERT INTO TBL_USER_INFO (USER_ID, GRADE_CODE, USER_NAME, USER_PASSWORD, AGENT_CODE, TABLEAU_INDEX, ADD_DATE, USE_START_DATE, USE_END_DATE, USER_EMAIL, ACCESS_IP)
		VALUES(#{userId}, #{gradeCode}, #{userName}, #{userPassword},2, #{tableauIndex}, now(), #{useStartDate}, #{useEndDate}, #{userEmail}, #{accessIp})
	</insert>

	<update id="updateUser" parameterType="UserInfo">
		UPDATE TBL_USER_INFO
		SET
		  USER_NAME = #{userName}
		<if test="userPassword != null">
		, USER_PASSWORD = #{userPassword}
		</if>
		, TABLEAU_INDEX = #{tableauIndex}
		, USE_START_DATE = #{useStartDate}
		, USE_END_DATE = #{useEndDate}
		, USER_EMAIL = #{userEmail}
		, GRADE_CODE = #{gradeCode}
		, ACCESS_IP = #{accessIp}
		WHERE USER_ID = #{userId}
	</update>
	
	<select id="" parameterType ="" resultType="">
		<!-- 쿼리 -->
	</select>
</mapper>
